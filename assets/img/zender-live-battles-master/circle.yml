machine:
  node:
    version:
      6.8.1
  services:
    - docker

general:
  branches:
    ignore:
      - development
      - master

dependencies:
  override:
    - cd ./backend && npm i
#    - cd ./frontend && npm i

test:
  pre:
    - cd dynamo && docker-compose up -d
  override:
    # - cd ./frontend && npm run build <-- Temp fix for blocking warning CRA (see https://github.com/webpack/webpack/issues/4263)
    - cd ./backend && npm t

deployment:
  staging:
    branch: staging
    commands:
        - echo -e "[default]\naws_access_key_id=$AWS_ACCESS_KEY\naws_secret_access_key=$AWS_SECRET_KEY\n" > ~/.aws/credentials 
        - cd ./frontend && docker build -t zender-live-battles .
        - cd ./backend && docker build -t zender-live-battles-backend .
        - $(aws ecr get-login --region us-west-2)
        - docker tag zender-live-battles:latest $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/zender-live-battles:latest
        - docker tag zender-live-battles-backend:latest $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/zender-live-battles-backend:latest
        - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/zender-live-battles:latest
        - docker push $AWS_ACCOUNT_ID.dkr.ecr.us-west-2.amazonaws.com/zender-live-battles-backend:latest
  production:
    branch: production
    commands:
        - echo -e "[default]\naws_access_key_id=$AWS_ACCESS_KEY_PROD\naws_secret_access_key=$AWS_SECRET_KEY_PROD\n" > ~/.aws/credentials 
        - $(aws ecr get-login --region eu-west-1)
        - cd ./backend && docker build -t zender-production-live-livebattles .
        - docker tag zender-production-live-livebattles:latest $AWS_ACCOUNT_ID_PRODUCTION.dkr.ecr.eu-west-1.amazonaws.com/zender-production-live-livebattles:latest 
        - docker push $AWS_ACCOUNT_ID_PRODUCTION.dkr.ecr.eu-west-1.amazonaws.com/zender-production-live-livebattles:latest 
